const grid = document.getElementById('grid');
const btnRv = document.getElementById('togglebtnRv');

let visibleRows = 3;
let expanded = false;

function updateMaskedRows() {
  const items = Array.from(grid.children);
  if (items.length === 0) return;

  // вычисляем top каждого элемента относительно контейнера грида
  const containerTop = grid.getBoundingClientRect().top;
  const tops = items.map(it => Math.round(it.getBoundingClientRect().top - containerTop));

  // собираем уникальные значения top (с небольшим допуском, чтобы сгруппировать близкие значения)
  const uniq = [];
  tops.forEach(t => {
    if (!uniq.some(u => Math.abs(u - t) <= 2)) uniq.push(t);
  });
  uniq.sort((a,b) => a - b);

  // если уникальных рядов меньше или равно visibleRows — ничего не маскируем
  if (uniq.length <= visibleRows) {
    items.forEach(it => it.classList.remove('masked'));
    return;
  }

  // top порога — последнее видимое значение top
  const thresholdTop = uniq[visibleRows - 1];

  // маскируем все элементы, чья топ-координата > thresholdTop
  items.forEach((it, idx) => {
    const top = Math.round(it.getBoundingClientRect().top - containerTop);
    if (top > thresholdTop + 1) it.classList.add('masked');
    else it.classList.remove('masked');
  });
}

// debounce для ресайза
let resizeTimer;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(updateMaskedRows, 120);
});

// если в карточках есть картинки — подождём их загрузки, потом обновим
window.addEventListener('load', () => {
  // небольшой таймаут, чтобы layout успел устаканиться
  setTimeout(updateMaskedRows, 50);
});

// кнопка переключения
btnRv.addEventListener('click', () => {
  expanded = !expanded;
  if (expanded) {
    // снять маски — показать всё
    Array.from(grid.children).forEach(it => it.classList.remove('masked'));
    btnRv.textContent = 'Свернуть';
  } else {
    updateMaskedRows();
    btnRv.textContent = 'Показать ещё';
  }
});

// инициализация (если нужно изначально скрыть свыше 3-х строк)
updateMaskedRows();